<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Админ — ReadZoneBookings</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--accent:#6a11cb;--danger:#ef4444;--muted:#6b7280;--radius:12px}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;padding:20px;color:#111}
  .wrap{max-width:1200px;margin:0 auto}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
  h1{margin:0;color:var(--accent)}
  .muted{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  input[type="search"], select, input[type="date"], button{padding:10px 15px;border-radius:6px;border:1px solid #d1d5db;font-size:14px}
  button{cursor:pointer;background:var(--accent);color:#fff;border:none}
  button.danger{background:var(--danger)}
  .table-container{overflow-x:auto}
  table{width:100%;border-collapse:collapse;margin-top:16px;font-size:14px}
  th,td{padding:12px 10px;text-align:left;border-bottom:1px solid #e5e7eb;vertical-align:top}
  th{background:#f3f4f6;font-weight:600}
  tr:hover{background:#fafafa}
  #log{margin-top:20px;font-family:monospace;white-space:pre-wrap;font-size:12px;color:var(--muted);border-top:1px solid #e5e7eb;padding-top:10px}
  .modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);justify-content:center;align-items:center}
  .modal-content{background:#fff;padding:16px;border-radius:10px;width:90%;max-width:420px;position:relative}.close-btn{position:absolute;right:12px;top:6px;font-size:22px;cursor:pointer}
  .modal-btn{width:100%;padding:10px;border-radius:6px;cursor:pointer;margin-top:10px}
  .modal-btn.delete{background:#dc3545;color:white}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>Админ-панель</h1>
    <span id="userInfo" class="muted">Загрузка...</span>
    <button id="logout" style="width:auto">Выйти</button>
  </div>
  <div class="card">
    <div id="statusMessage"></div>
    <div class="controls">
      <input type="search" id="userSearch" placeholder="Поиск по Email пользователя"/>
      <input type="search" id="bookingSearch" placeholder="Поиск по бронированию"/>
      <select id="dateFilter"></select>
      <button onclick="exportBookingsToCsv()">Экспорт в CSV</button>
      <button class="danger" onclick="massDeleteBookings()">Массовое удаление</button>
    </div>
    <div class="table-container">
      <table id="bookingsTable">
        <thead>
          <tr><th>ID</th><th>Комната</th><th>Пользователь</th><th>Время</th><th>Комментарий</th><th>Действия</th></tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>
  </div>
</div>
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3 id="modalTitle"></h3>
    <p id="modalMessage"></p>
    <div id="modalButtons"></div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://ufdpcktbgazzrqzqxxhf.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmZHBja3RiZ2F6enJxenF4eGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Mjc4MzIsImV4cCI6MjA3NDEwMzgzMn0.GT3YDB3pKZyDqTX-I3dkZQb4xpWP8xK9bhMgFnaZhsM';
  const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let allBookings = [];
  let allUsers = [];

  const el = id => document.getElementById(id);

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { location.href = '/'; return; }

    const { data: profile } = await supabase.from('profiles').select('is_admin').eq('id', user.id).maybeSingle();
    if (!profile || !profile.is_admin) {
      alert('Нет доступа к админ-панели.');
      location.href = '/';
      return;
    }

    el('userInfo').textContent = `Залогинен как: ${user.email}`;
    el('logout').onclick = async () => { await supabase.auth.signOut(); location.href = '/'; };

    // Загружаем данные через Netlify-функцию
    await loadData();
    setupFilters();
  }

  async function loadData() {
    el('statusMessage').innerHTML = 'Загрузка данных...';
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        el('statusMessage').innerHTML = '<div style="color:red;">Сессия не найдена. Попробуйте перезагрузить страницу.</div>';
        return;
      }
      const res = await fetch('/.netlify/functions/get-admin-data', {
        headers: { 'Authorization': `Bearer ${session.access_token}` }
      });

      if (!res.ok) {
        const errorData = await res.json();
        el('statusMessage').innerHTML = `<div style="color:red;">Ошибка загрузки данных: ${errorData.error}</div>`;
        return;
      }

      const data = await res.json();
      allBookings = data.bookings;
      allUsers = data.users;
      renderBookings();
      el('statusMessage').innerHTML = `<div style="color:green;">Данные загружены. Бронирований: ${allBookings.length}, пользователей: ${allUsers.length}.</div>`;

    } catch (e) {
      el('statusMessage').innerHTML = `<div style="color:red;">Критическая ошибка: ${e.message}</div>`;
      console.error(e);
    }
  }
  
  function renderBookings(filteredBookings = allBookings) {
    const tableBody = el('bookingsTable').querySelector('tbody');
    tableBody.innerHTML = '';
    if (filteredBookings.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Бронирований не найдено.</td></tr>';
      return;
    }

    filteredBookings.forEach(b => {
      const user = allUsers.find(u => u.id === b.user_id) || { email: 'Неизвестный', user_metadata: {} };
      const displayName = user.user_metadata.user_name || user.email;
      const start = new Date(b.start);
      const end = new Date(b.end);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${b.id.substring(0, 8)}...</td>
        <td>${escapeHtml(b.room || 'Читальный зал')}</td>
        <td>${escapeHtml(displayName)}</td>
        <td>${formatDateTime(start)} - ${formatDateTime(end)}</td>
        <td>${escapeHtml(b.comment)}</td>
        <td>
          <button onclick="showDeleteModal('${b.id}', '${escapeHtml(displayName)}')">Удалить</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function setupFilters() {
    el('userSearch').addEventListener('input', filterBookings);
    el('bookingSearch').addEventListener('input', filterBookings);
    el('dateFilter').addEventListener('change', filterBookings);

    const dates = [...new Set(allBookings.map(b => new Date(b.start).toISOString().split('T')[0]))];
    dates.sort().reverse();
    const dateFilter = el('dateFilter');
    dateFilter.innerHTML = '<option value="">Все даты</option>';
    dates.forEach(d => {
      const option = document.createElement('option');
      option.value = d;
      option.textContent = d;
      dateFilter.appendChild(option);
    });
  }

  function filterBookings() {
    const userQuery = el('userSearch').value.toLowerCase();
    const bookingQuery = el('bookingSearch').value.toLowerCase();
    const dateValue = el('dateFilter').value;

    const filtered = allBookings.filter(b => {
      const user = allUsers.find(u => u.id === b.user_id) || {};
      const displayName = (user.user_metadata?.user_name || user.email || '').toLowerCase();
      const bookingComment = (b.comment || '').toLowerCase();
      const bookingDate = new Date(b.start).toISOString().split('T')[0];

      const userMatch = userQuery === '' || displayName.includes(userQuery);
      const bookingMatch = bookingQuery === '' || bookingComment.includes(bookingQuery) || b.id.toLowerCase().includes(bookingQuery);
      const dateMatch = dateValue === '' || bookingDate === dateValue;

      return userMatch && bookingMatch && dateMatch;
    });

    renderBookings(filtered);
  }

  function showDeleteModal(id, userDisplay) {
    const modal = el('deleteModal');
    el('modalTitle').textContent = `Удалить бронирование?`;
    el('modalMessage').textContent = `Вы уверены, что хотите удалить бронирование пользователя ${userDisplay}?`;
    el('modalButtons').innerHTML = `
      <button class="modal-btn delete" onclick="deleteBooking('${id}')">Удалить</button>
      <button class="modal-btn" onclick="closeModal()">Отмена</button>
    `;
    modal.style.display = 'flex';
  }

  async function deleteBooking(bookingId) {
    const modal = el('deleteModal');
    modal.style.display = 'none';

    try {
      const { data: { session } } = await supabase.auth.getSession();
      const res = await fetch('/.netlify/functions/delete-booking', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`
        },
        body: JSON.stringify({ bookingId })
      });

      if (!res.ok) {
        const errorData = await res.json();
        alert('Ошибка при удалении: ' + errorData.error);
        console.error(errorData);
        return;
      }
      
      alert('Бронирование успешно удалено.');
      await loadData();
    } catch (e) {
      alert('Критическая ошибка при удалении: ' + e.message);
      console.error(e);
    }
  }

  function massDeleteBookings() {
    alert('Эта функция пока не реализована.');
    // Можно добавить логику для массового удаления
  }

  function exportBookingsToCsv() {
    const headers = ['id', 'room', 'start', 'end', 'user_id', 'user_email', 'user_name'];
    const rows = allBookings.map(b => {
      const user = allUsers.find(u => u.id === b.user_id) || {};
      return [
        b.id, b.room, b.start, b.end, b.user_id,
        user.email || '', user.user_metadata?.user_name || ''
      ].map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(',');
    });
    const csv = [headers.map(h => `"${h}"`).join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bookings_export.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  
  function closeModal() { el('deleteModal').style.display = 'none'; }
  function escapeHtml(s) { if (s == null) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }
  function formatDateTime(d) { return d.toLocaleDateString('ru-RU') + ' ' + d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }

  init();
</script>
</body>
</html>
