<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Debug — ReadZoneBookings</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  body{font-family:Inter,system-ui,Arial;padding:18px;background:#f6f8fb;color:#111}
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
  h1{margin:0 0 8px;color:#2563eb}
  pre{background:#0b1220;color:#e6f1ff;padding:12px;border-radius:8px;overflow:auto;max-height:360px}
  button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer;margin-right:8px}
  button.ghost{background:#fff;border:1px solid #e6eef2;color:#111}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  label.small{font-size:13px;color:#666}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eee}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Admin — Diagnostics</h1>
    <div class="small">Этот экран покажет почему админ-панель пустая. Нажми <b>Run diagnostics</b> и скопируй вывод сюда.</div>
    <div style="margin-top:10px" class="row">
      <button id="runDiag">Run diagnostics</button>
      <button id="loadBookings" class="ghost">Загрузить брони</button>
      <button id="loadProfiles" class="ghost">Загрузить profiles</button>
      <button id="testDelete" class="ghost">Попробовать удалить 1 бронь (тест)</button>
      <button id="logout" class="ghost">Sign out</button>
    </div>

    <div style="margin-top:12px">
      <label class="small">Supabase URL / ANON key (проверь)</label>
      <div id="keys" style="font-size:13px;color:#333;word-break:break-all"></div>
    </div>

    <h3 style="margin-top:12px">Live output</h3>
    <pre id="out">Нажмите Run diagnostics...</pre>

    <h3 style="margin-top:12px">Краткая таблица бронирований (если загрузятся)</h3>
    <div id="tableWrap"></div>
  </div>
</div>

<script>
/* ====== ВСТАВЬ СВОИ (если нужно) ====== */
const SUPABASE_URL = "https://ufdpcktbgazzrqzqxxhf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmZHBja3RiZ2F6enJxenF4eGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Mjc4MzIsImV4cCI6MjA3NDEwMzgzMn0.GT3YDB3pKZyDqTX-I3dkZQb4xpWP8xK9bhMgFnaZhsM";
/* ===================================== */

const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const out = id => document.getElementById(id);
function logln(s){ const p = out('out'); p.textContent += '\\n' + s; p.scrollTop = p.scrollHeight; }
function clearOut(){ out('out').textContent = ''; out('tableWrap').innerHTML = ''; }

document.getElementById('keys').textContent = SUPABASE_URL + ' — ' + (SUPABASE_ANON_KEY ? ('ANON (len '+SUPABASE_ANON_KEY.length+')') : 'NO_KEY');

async function runDiagnostics(){
  clearOut();
  logln('=== Diagnostics started: ' + new Date().toLocaleString() + ' ===');

  // 1) session
  try{
    const sessionRes = await supabase.auth.getSession();
    logln('[session] getSession() => ' + JSON.stringify(sessionRes, null, 2));
  } catch(e){ logln('[session] ERROR: ' + e.message); }

  // 2) user
  try{
    const { data: { user }, error } = await supabase.auth.getUser();
    logln('[user] getUser() => ' + (error ? ('ERROR: '+ error.message) : JSON.stringify(user, null, 2)));
    if (!user) { logln('>>> Пользователь не авторизован. Выйди и войди снова.'); }
  } catch(e){ logln('[user] ERROR: ' + e.message); }

  // 3) try select bookings
  try{
    logln('[bookings] trying select * from public.bookings (limit 10)');
    const { data, error } = await supabase.from('bookings').select('*').order('created_at',{ascending:false}).limit(10);
    logln('[bookings] response error: ' + (error ? JSON.stringify(error) : 'null'));
    logln('[bookings] rows: ' + (data ? data.length : 0));
    if (data && data.length) {
      logln('[bookings] sample row: ' + JSON.stringify(data[0], null, 2));
      renderTable(data);
    } else {
      logln('[bookings] пусто — либо нет записей, либо RLS блокирует SELECT (см. error).');
    }
  } catch(e){ logln('[bookings] EXCEPTION: ' + e.message); }

  // 4) try select profiles
  try{
    logln('[profiles] trying select * from public.profiles (limit 10)');
    const { data, error } = await supabase.from('profiles').select('*').limit(10);
    logln('[profiles] response error: ' + (error ? JSON.stringify(error) : 'null'));
    logln('[profiles] rows: ' + (data ? data.length : 0));
    if (data && data.length) logln('[profiles] sample: ' + JSON.stringify(data[0], null, 2));
  } catch(e){ logln('[profiles] EXCEPTION: ' + e.message); }

  // 5) check policies hint (best-effort)
  logln('[hint] Если в error возвращается "permission_denied" или RLS — зайди в Supabase → SQL Editor и проверь политики для bookings/profiles (мы давали скрипт).');
  logln('=== Diagnostics finished ===');
}

function renderTable(rows){
  const wrap = document.getElementById('tableWrap');
  const table = document.createElement('table');
  const head = '<tr><th>ID</th><th>user_email</th><th>user_id</th><th>room</th><th>start</th></tr>';
  table.innerHTML = head;
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.id||''}</td><td>${r.user_email||''}</td><td>${r.user_id||''}</td><td>${r.room||''}</td><td>${r.start||''}</td>`;
    table.appendChild(tr);
  });
  wrap.innerHTML = '';
  wrap.appendChild(table);
}

// explicit loaders
document.getElementById('runDiag').addEventListener('click', runDiagnostics);
document.getElementById('loadBookings').addEventListener('click', async ()=>{
  clearOut(); logln('manual loadBookings...');
  try{ const { data, error } = await supabase.from('bookings').select('*').order('created_at',{ascending:false}).limit(50); logln('error: '+JSON.stringify(error)); logln('rows: '+(data?data.length:0)); if(data) renderTable(data); }catch(e){ logln('EX: '+e.message); }
});
document.getElementById('loadProfiles').addEventListener('click', async ()=>{
  clearOut(); logln('manual loadProfiles...');
  try{ const { data, error } = await supabase.from('profiles').select('*').limit(50); logln('error: '+JSON.stringify(error)); logln('rows: '+(data?data.length:0)); if(data && data.length) logln('sample: '+JSON.stringify(data[0], null,2)); }catch(e){ logln('EX: '+e.message); }
});
document.getElementById('testDelete').addEventListener('click', async ()=>{
  clearOut(); logln('test delete: will try to delete most recent booking (if any).');
  try{
    const { data: bookings } = await supabase.from('bookings').select('*').order('created_at',{ascending:false}).limit(1);
    if(!bookings || !bookings.length){ logln('no bookings to test-delete'); return; }
    const id = bookings[0].id;
    logln('trying delete id=' + id);
    const { data, error } = await supabase.from('bookings').delete().eq('id', id);
    logln('delete error: ' + JSON.stringify(error));
    logln('delete data: ' + JSON.stringify(data));
  }catch(e){ logln('EX: '+e.message); }
});
document.getElementById('logout').addEventListener('click', async ()=>{
  await supabase.auth.signOut();
  alert('Signed out — refresh page and sign in again.');
});

// auto-run diagnostics on load (optional)
window.addEventListener('load', ()=>{ /* nothing auto */ });
</script>
</body>
</html>
