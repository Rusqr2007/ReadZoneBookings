<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Админ-панель</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    /* --- (твои стили можно оставить как есть) --- */
    :root{--primary-color:#6a11cb;--secondary-color:#2575fc;--background-color:#f6f8fb;--card-background:#fff;--text-color:#333;--subtle-text-color:#777;--border-color:#e0e0e0;--shadow:0 10px 30px rgba(0,0,0,.08);--border-radius:16px}
    body{font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;padding:22px;background:var(--background-color);color:var(--text-color);display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
    .container{background:var(--card-background);padding:40px;border-radius:var(--border-radius);box-shadow:var(--shadow);width:100%;max-width:900px;margin-top:50px}
    h2,h3{text-align:center;color:var(--primary-color);margin-bottom:20px}
    .tabs{display:flex;justify-content:center;margin-bottom:20px;border-bottom:2px solid var(--border-color)}
    .tab-button{background:none;border:none;padding:15px 30px;cursor:pointer;font-size:16px;color:var(--subtle-text-color)}
    .tab-button.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color);font-weight:700}
    .tab-content{display:none}
    .tab-content.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{text-align:left;padding:12px;border-bottom:1px solid var(--border-color)}
    th{background:#f0f0f0;font-weight:600}
    tr:hover{background:#f9f9f9}
    button{background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));color:#fff;padding:10px 15px;border:none;border-radius:8px;cursor:pointer}
    button:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,0.1)}
  </style>
</head>
<body>
  <div class="container">
    <h2>Админ-панель</h2>
    <p>Вы вошли как админ <span id="user-email"></span></p>

    <div class="tabs">
      <button class="tab-button active" onclick="showTab('users')">Пользователи</button>
      <button class="tab-button" onclick="showTab('bookings')">Бронирования</button>
    </div>

    <div id="users-tab" class="tab-content active">
      <h3>Все пользователи</h3>
      <table id="usersTable">
        <thead><tr><th>Email</th><th>ID</th><th>Дата создания</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="bookings-tab" class="tab-content">
      <h3>Все бронирования</h3>
      <table id="bookingsTable">
        <thead><tr><th>ID</th><th>Комната</th><th>Дата</th><th>Время</th><th>Пользователь</th><th>Действия</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  const SUPABASE_URL = 'https://ufdpcktbgazzrqzqxxhf.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmZHBja3RiZ2F6enJxenF4eGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Mjc4MzIsImV4cCI6MjA3NDEwMzgzMn0.GT3YDB3pKZyDqTX-I3dkZQb4xpWP8xK9bhMgFnaZhsM';
  const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function checkAuth() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) { alert('Сначала войдите'); location.href = '/'; return; }
    // показываем почту
    document.getElementById('user-email').textContent = user.email;
    // запрашиваем у serverless функции данные (отправляем Bearer token)
    fetchAdminData();
  }

  async function fetchAdminData() {
    try {
      const token = (await supabase.auth.getSession()).data.session?.access_token;
      if (!token) throw new Error('Не найден токен сессии');

      const res = await fetch('/.netlify/functions/get-admin-data', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({error:res.statusText}));
        throw new Error(err.error || res.statusText);
      }
      const { users, bookings } = await res.json();
      displayUsers(users);
      displayBookings(bookings);
    } catch (err) {
      console.error(err);
      alert('Ошибка: ' + err.message);
      // при ошибке можно перенаправить
      // location.href = '/';
    }
  }

  function displayUsers(users) {
    const body = document.querySelector('#usersTable tbody'); body.innerHTML = '';
    users.forEach(u => {
      body.innerHTML += `<tr><td>${u.email}</td><td>${u.id}</td><td>${new Date(u.created_at).toLocaleString()}</td></tr>`;
    });
  }

  function displayBookings(bookings) {
    const body = document.querySelector('#bookingsTable tbody'); body.innerHTML = '';
    bookings.forEach(b=>{
      body.innerHTML += `<tr>
        <td>${b.id}</td>
        <td>${b.room}</td>
        <td>${new Date(b.start).toLocaleDateString()}</td>
        <td>${new Date(b.start).toLocaleTimeString()} - ${new Date(b.end).toLocaleTimeString()}</td>
        <td>${b.user_email}</td>
        <td><button onclick="deleteBooking('${b.id}')">Удалить</button></td>
      </tr>`;
    });
  }

  async function deleteBooking(id) {
    if (!confirm('Удалить бронь?')) return;
    try {
      const token = (await supabase.auth.getSession()).data.session?.access_token;
      const res = await fetch('/.netlify/functions/delete-booking', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ bookingId: id })
      });
      if (!res.ok) throw new Error((await res.json()).error || 'Ошибка');
      alert('Готово');
      fetchAdminData();
    } catch (err) {
      console.error(err);
      alert('Ошибка удаления: ' + err.message);
    }
  }

  function showTab(tabName){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
  }

  checkAuth();
</script>
</body>
</html>
