<script>
const SUPABASE_URL = 'https://ufdpcktbgazzrqzqxxhf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmZHBja3RiZ2F6enJxenF4eGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1Mjc4MzIsImV4cCI6MjA3NDEwMzgzMn0.GT3YDB3pKZyDqTX-I3dkZQb4xpWP8xK9bhMgFnaZhsM';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;

async function checkUserAndRedirect() {
  const { data: { user } } = await supabase.auth.getUser();

  if (user) {
    // Читаем профиль в таблице profiles
    const { data: profile, error } = await supabase
      .from('profiles')
      .select('is_admin')
      .eq('id', user.id)
      .single();

    if (error) {
      console.error('Ошибка чтения профиля:', error.message);
      currentUser = user;
      showBookingForm();
      return;
    }

    if (profile && profile.is_admin) {
      console.log("Администратор вошёл в систему. Перенаправление...");
      window.location.href = '/admin.html';
    } else {
      currentUser = user;
      showBookingForm();
    }
  } else {
    showAuthForm();
  }
}

        
        document.addEventListener('DOMContentLoaded', async function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bookingDate').value = today;
            document.getElementById('bookingDate').min = today;
            // Removed the max attribute to allow cross-day bookings
            
            await cleanupOldBookings();
            await checkUserAndRedirect();
        });

        async function cleanupOldBookings() {
            try {
                const now = new Date();
                const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

                const { error, count } = await supabase
                    .from('bookings')
                    .delete()
                    .lt('end', twentyFourHoursAgo.toISOString());

                if (error) {
                    console.error('Ошибка при удалении старых броней:', error);
                } else if (count > 0) {
                    console.log(`Удалено ${count} старых броней`);
                }
            } catch (error) {
                console.error('Общая ошибка при очистке:', error);
            }
        }

        async function signUp() {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!name || !email || !password) {
                showMessage('authMessage', 'Заполните все поля', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('authMessage', 'Пароль должен содержать минимум 6 символов', 'error');
                return;
            }
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        full_name: name
                    }
                }
            });
            
            if (error) {
                showMessage('authMessage', error.message, 'error');
            } else {
                showMessage('authMessage', 'Регистрация успешна! Проверьте email для подтверждения.', 'success');
            }
        }

        async function signIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('authMessage', 'Заполните все поля', 'error');
                return;
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                showMessage('authMessage', error.message, 'error');
            } else {
                showMessage('authMessage', 'Вход выполнен!', 'success');
                setTimeout(checkUserAndRedirect, 1000);
            }
        }

        async function requestPasswordReset() {
            const email = document.getElementById('resetEmail').value.trim();
            if (!email) {
                showMessage('resetMessage', 'Введите ваш email', 'error');
                return;
            }

            const { error } = await supabase.auth.resetPasswordForEmail(email);

            if (error) {
                showMessage('resetMessage', 'Ошибка: ' + error.message, 'error');
            } else {
                showMessage('resetMessage', 'Инструкции по сбросу пароля отправлены на ваш email.', 'success');
            }
        }

        async function signOut() {
            await supabase.auth.signOut();
            currentUser = null;
            showAuthForm();
        }

        async function createBooking() {
            const date = document.getElementById('bookingDate').value;
            const timeStart = document.getElementById('time-start').value;
            const timeEnd = document.getElementById('time-end').value;

            if (!date || !timeStart || !timeEnd) {
                showMessage('bookingMessage', 'Заполните все поля', 'error');
                return;
            }
            
            const startTime = new Date(date + 'T' + timeStart);
            let endTime = new Date(date + 'T' + timeEnd);

            if (isNaN(startTime) || isNaN(endTime)) {
                showMessage('bookingMessage', 'Неверная дата или время', 'error');
                return;
            }

            // Если время окончания раньше времени начала, значит, бронь переходит на следующий день
            if (endTime <= startTime) {
                endTime.setDate(endTime.getDate() + 1);
            }

            const durationMs = endTime - startTime;
            const maxDurationMs = 4 * 60 * 60 * 1000;
            
            if (durationMs <= 0) {
                 showMessage('bookingMessage', 'Время окончания должно быть позже времени начала.', 'error');
                return;
            }
            if (durationMs > maxDurationMs) {
                showMessage('bookingMessage', 'Максимальная длительность брони — 4 часа', 'error');
                return;
            }
            
            const isTimeAvailable = await checkTimeAvailability(startTime, endTime);
            if (!isTimeAvailable) {
                showMessage('bookingMessage', 'На выбранное время уже есть бронь. Выберите другое время.', 'error');
                return;
            }

            const { error } = await supabase
                .from('bookings')
                .insert([{
                    user_id: currentUser.id,
                    user_email: currentUser.email,
                    room: 'Читальный зал',
                    start: startTime.toISOString(),
                    end: endTime.toISOString()
                }]);
            
            if (error) {
                showMessage('bookingMessage', 'Ошибка при создании брони: ' + error.message, 'error');
            } else {
                showMessage('bookingMessage', 'Бронь создана успешно!', 'success');
                loadUserBookings();
                loadAllBookings();
            }
        }

        async function checkTimeAvailability(newStartTime, newEndTime) {
            try {
                const { data: existingBookings, error } = await supabase
                    .from('bookings')
                    .select('start, end')
                    .eq('room', 'Читальный зал');

                if (error) {
                    console.error('Ошибка при проверке доступности времени:', error);
                    return true;
                }

                if (!existingBookings || existingBookings.length === 0) {
                    return true;
                }

                for (const booking of existingBookings) {
                    const existingStart = new Date(booking.start);
                    const existingEnd = new Date(booking.end);

                    if (
                        (newStartTime < existingEnd && newEndTime > existingStart)
                    ) {
                        return false;
                    }
                }
                return true;
            } catch (err) {
                console.error('Ошибка при проверке доступности:', err);
                return true;
            }
        }
        
        async function loadUserBookings() {
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('start', { ascending: true });
            
            const bookingsList = document.getElementById('bookingsList');
            
            if (error || !bookings || bookings.length === 0) {
                bookingsList.innerHTML = '<p>У вас пока нет броней</p>';
                return;
            }
            
            bookingsList.innerHTML = bookings.map(booking => {
                const startTime = new Date(booking.start);
                const endTime = new Date(booking.end);
                const duration = Math.round((endTime - startTime) / (1000 * 60 * 60));
                
                return `
                    <div class="booking-item" data-id="${booking.id}" data-user-id="${booking.user_id}">
                        <div class="booking-time">${startTime.toLocaleDateString('ru-RU')} в ${startTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
                        <div class="booking-duration">Длительность: ${duration} час(а)</div>
                    </div>
                `;
            }).join('');
            
            addClickListeners(bookings);
        }

        async function loadAllBookings() {
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*')
                .order('start', { ascending: true });
            
            const allBookingsList = document.getElementById('allBookingsList');
            
            if (error || !bookings || bookings.length === 0) {
                allBookingsList.innerHTML = '<p>Броней пока нет</p>';
                return;
            }

            allBookingsList.innerHTML = bookings.map(booking => {
                const startTime = new Date(booking.start);
                const endTime = new Date(booking.end);
                
                const displayName = booking.user_email || 'Неизвестно';
                
                return `
                    <div class="booking-item" style="border-left: 4px solid #764ba2;" data-id="${booking.id}" data-user-id="${booking.user_id}">
                        <div class="booking-time">${displayName} — ${booking.room}</div>
                        <div class="booking-duration">${startTime.toLocaleDateString('ru-RU')} c ${startTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})} до ${endTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                `;
            }).join('');
            
            addClickListeners(bookings);
        }
        
        function addClickListeners(bookings) {
            document.querySelectorAll('.booking-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const bookingId = e.currentTarget.getAttribute('data-id');
                    const booking = bookings.find(b => b.id == bookingId);
                    if (booking) {
                        showBookingDetails(booking);
                    }
                });
            });
        }
        
        async function showBookingDetails(booking) {
            const modal = document.getElementById('bookingModal');
            const modalInfo = document.getElementById('modalInfo');
            
            const userEmail = booking.user_email || 'Не указан';

            let deleteButtonHTML = '';
            if (currentUser && booking.user_id === currentUser.id) {
                deleteButtonHTML = `<button class="modal-delete-btn" onclick="confirmDelete('${booking.id}')">Удалить</button>`;
            }

            modalInfo.innerHTML = `
                <h3 class="modal-title">Детали бронирования</h3>
                <p><span class="modal-item-label">Комната:</span> ${booking.room}</p>
                <p><span class="modal-item-label">Дата:</span> ${new Date(booking.start).toLocaleDateString('ru-RU')}</p>
                <p><span class="modal-item-label">Время:</span> ${new Date(booking.start).toLocaleTimeString('ru-RU')} - ${new Date(booking.end).toLocaleTimeString('ru-RU')}</p>
                <p><span class="modal-item-label">Забронировал:</span> ${userEmail}</p>
                ${deleteButtonHTML}
            `;
            
            modal.style.display = 'flex';
        }

        function confirmDelete(bookingId) {
            if (confirm('Вы уверены, что хотите удалить эту бронь?')) {
                deleteBooking(bookingId);
            }
        }

        async function deleteBooking(bookingId) {
            if (!currentUser) {
                alert('Вы не авторизованы для удаления бронирования.');
                return;
            }

            const { error } = await supabase
                .from('bookings')
                .delete()
                .eq('id', bookingId)
                .eq('user_id', currentUser.id);

            if (error) {
                alert('Ошибка при удалении брони: ' + error.message);
            } else {
                alert('Бронь успешно удалена!');
                document.getElementById('bookingModal').style.display = 'none';
                loadUserBookings();
                loadAllBookings();
            }
        }

        function showSettings() {
            hideAllCards();
            document.getElementById('settingsCard').classList.add('active');
            loadUserSettings();
        }

        async function loadUserSettings() {
            if (currentUser) {
                document.getElementById('settingsEmail').value = currentUser.email;
                const fullName = currentUser.user_metadata?.full_name || '';
                document.getElementById('settingsName').value = fullName;
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }
        }

        async function updateProfile() {
            const newName = document.getElementById('settingsName').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newName) {
                showMessage('settingsMessage', 'Имя не может быть пустым', 'error');
                return;
            }

            if (newPassword || confirmPassword) {
                if (newPassword !== confirmPassword) {
                    showMessage('settingsMessage', 'Пароли не совпадают', 'error');
                    return;
                }
                if (newPassword.length < 6) {
                    showMessage('settingsMessage', 'Пароль должен содержать минимум 6 символов', 'error');
                    return;
                }
            }

            try {
                const updateData = {
                    data: { full_name: newName }
                };

                if (newPassword) {
                    updateData.password = newPassword;
                }

                const { error } = await supabase.auth.updateUser(updateData);

                if (error) {
                    showMessage('settingsMessage', 'Ошибка обновления: ' + error.message, 'error');
                } else {
                    showMessage('settingsMessage', 'Настройки успешно обновлены!', 'success');
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                }
            } catch (err) {
                showMessage('settingsMessage', 'Произошла ошибка при обновлении настроек', 'error');
            }
        }

        function hideAllCards() {
            document.getElementById('authCard').classList.remove('active');
            document.getElementById('bookingCard').classList.remove('active');
            document.getElementById('passwordResetCard').classList.remove('active');
            document.getElementById('settingsCard').classList.remove('active');
        }

        function showAuthForm() {
            hideAllCards();
            document.getElementById('authCard').classList.add('active');
        }

        function showPasswordReset() {
            hideAllCards();
            document.getElementById('passwordResetCard').classList.add('active');
        }

        function showBookingForm() {
            hideAllCards();
            document.getElementById('bookingCard').classList.add('active');
            loadUserBookings();
            loadAllBookings();
        }
        
        document.querySelector('.close-btn').addEventListener('click', () => {
            document.getElementById('bookingModal').style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === document.getElementById('bookingModal')) {
                document.getElementById('bookingModal').style.display = 'none';
            }
        });

        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }
    </script>
